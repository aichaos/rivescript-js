/* rivescript 1.0.5 -- built on 2015-02-11 05:07:46 */
!function(publish){function JsRiveObjects(a){this._master=a,this._objects={}}function RiveScript(a){this._debug=!1,this._strict=!0,this._depth=50,this._utf8=!1,this._div=void 0,this._node={},this._runtime=this.runtime(),this._pending=[],this._loadcount=0,this._gvars={},this._bvars={},this._subs={},this._person={},this._arrays={},this._users={},this._freeze={},this._includes={},this._lineage={},this._handlers={},this._objlangs={},this._topics={},this._thats={},this._sorted={},this._current_user=void 0,"object"==typeof a&&(a.debug&&(this._debug=a.debug?!0:!1),a.strict&&(this._strict=a.strict?!0:!1),a.depth&&(this._depth=parseInt(a.depth)),a.debug_div&&(this._div=a.debug_div,0!==this._div.indexOf("#")&&(this._div="#"+this._div)),a.utf8&&(this._utf8=!!a.utf8)),this._handlers.javascript=new JsRiveObjects(this),this.say("RiveScript Interpreter v"+VERSION+" Initialized."),this.say("Runtime Environment: "+this._runtime)}JsRiveObjects.prototype.load=function(name,code){var source='this._objects["'+name+'"] = function (rs, args) {\n'+code.join("\n")+"}\n";try{eval(source)}catch(e){this._master.warn("Error evaluating JavaScript object: "+e.message)}},JsRiveObjects.prototype.call=function(a,b,c,d){var e=this._objects[b],f="";try{f=e.call(d,a,c)}catch(g){f="[ERR: Error when executing JavaScript object]"}return void 0===f&&(f=""),f};var VERSION="1.0.5",RS_VERSION="2.0";RiveScript.prototype.version=function(){return VERSION},RiveScript.prototype.runtime=function(){return Object.keys||this._shim_keys(),"undefined"==typeof window&&"object"==typeof module?(this._node.fs=require("fs"),"node"):"web"},RiveScript.prototype.say=function(a){this._debug===!0&&(this._div?$(this._div).append("<div>[RS] "+this._escape_html(a)+"</div>"):console&&console.log&&console.log("[RS] "+a))},RiveScript.prototype.warn=function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(a+=" at "+b+" line "+c),this._div?$(this._div).append("<div style='color: #FF0000; font-weight: bold'>"+this._escape_html(a)+"</div>"):console?console.error?console.error(a):console.log&&console.log("[WARNING] "+a):window.alert(a)},RiveScript.prototype.loadFile=function(a,b,c){"string"==typeof a&&(a=[a]);var d=this._loadcount++;this._pending[d]={};for(var e=0;e<a.length;e++){var f=a[e];this.say("Request to load file: "+f),this._pending[d][f]=1,"web"===this._runtime?this._ajax_load_file(d,f,b,c):"node"===this._runtime&&this._node_load_file(d,f,b,c)}return d},RiveScript.prototype._ajax_load_file=function(a,b,c,d){var e=this;$.ajax({url:b,dataType:"text",success:function(f){e.say("Loading file "+b+" complete."),e.parse(b,f,d),delete e._pending[a][b],0===Object.keys(e._pending[a]).length&&"function"==typeof c&&c.call(void 0,a)},error:function(b,c,f){e.say("Error! "+c+"; "+f),"function"==typeof d&&d.call(void 0,a,c)}})},RiveScript.prototype._node_load_file=function(a,b,c,d){var e=this;this._node.fs.readFile(b,function(f,g){return f?void("function"==typeof d?d.call(void 0,a,f):e.warn(f)):(e.parse(b,""+g,d),delete e._pending[a][b],void(0===Object.keys(e._pending[a]).length&&"function"==typeof c&&c.call(void 0,a)))})},RiveScript.prototype.loadDirectory=function(a,b,c){if("web"===this._runtime)return void this.warn("loadDirectory can't be used on the web!");var d=this._loadcount++;this._pending[d]={};var e=this;this._node.fs.readdir(a,function(f,g){if(f)return void("function"==typeof c?c.call(void 0,f):e.warn(f));for(var h=[],i=0,j=g.length;j>i;i++)g[i].match(/\.(rive|rs)$/i)&&(e._pending[d][a+"/"+g[i]]=1,h.push(a+"/"+g[i]));for(i=0,j=h.length;j>i;i++){{h[i]}e._node_load_file(d,h[i],b,c)}})},RiveScript.prototype.stream=function(a,b){return this.say("Streaming code."),this.parse("stream()",a,b)},RiveScript.prototype.parse=function(a,b,c){this.say("Parsing code!");for(var d="random",e=0,f=!1,g=!1,h="",i="",j=[],k="",l=0,m=0,n="",o={concat:"none"},p={none:"",newline:"\n",space:" "},q=b.split("\n"),r=0,s=q.length;s>r;r++){var t=q[r];if(e=r+1,t=this._strip(t),0!==t.length)if(g)t.indexOf("< object")>-1?(h.length>0&&(this._handlers[i]?(this._objlangs[h]=i,this._handlers[i].load(h,j)):this.warn("Object creation failed: no handler for "+i,a,e)),h="",i="",j="",g=!1):j.push(t);else if(0!==t.indexOf("//"))if(0!==t.indexOf("#"))if(0!==t.indexOf("/*")){if(t.indexOf("*/")>-1)f=!1;else if(!f)if(t.length<2)this.warn("Weird single-character line '"+t+"' found",a,e);else{var u=t.substring(0,1);t=this._strip(t.substring(1)),t.indexOf(" // ")>-1&&(t=this._strip(t.split(" // ")[0]));var v=this.checkSyntax(u,t);if(""!==v){if(this._strict&&"function"==typeof c)return c.call(null,"Syntax error: "+v+" at "+a+" line "+e+", near "+u+" "+t),!1;this.warn("Syntax error: "+v)}"+"===u&&(n="");for(var w=r+1;s>w;w++){var x=this._strip(q[w]);if(!(x.length<2)){var y=x.substring(0,1);if(x=this._strip(x.substring(1)),0!==x.length){if("^"!==y&&"%"!==y)break;if("+"===u){if("%"===y){n=x;break}n=""}if("!"===u){"^"===y&&(t+="<crlf>"+x);continue}if("^"!==u&&"%"!==y){if("^"!==y)break;t+=void 0!==p[o.concat]?p[o.concat]+x:x}}}}this.say("Cmd: '"+u+"'; line: "+t);var z;switch(u){case"!":var A=t.split("=",2),B=this._strip(A[0]).split(" "),C="",D="",E="";if(2===A.length&&(C=this._strip(A[1])),B.length>=1&&(D=this._strip(B[0]),B.length>=2&&(B.shift(),E=this._strip(B.join(" ")))),"array"!==D&&(C=C.replace(/<crlf>/g,"")),"version"===D){if(parseFloat(C)>parseFloat(RS_VERSION))return this.warn("Unsupported RiveScript version. We only support "+RS_VERSION,a,e),!1;continue}if(0===E.length){this.warn("Undefined variable name",a,e);continue}if(0===C.length){this.warn("Undefined variable value",a,e);continue}if("local"===D)this.say("Set local parser option "+E+" = "+C),o[E]=C;else if("global"===D){if(this.say("Set global "+E+" = "+C),"<undef>"===C){delete this._gvars[E];continue}this._gvars[E]=C,"debug"===E?this._debug="true"===C.toLowerCase()?!0:!1:"depth"===E?this._depth=parseInt(C):"strict"===E&&(this._strict="true"===C.toLowerCase()?!0:!1)}else if("var"===D)this.say("Set bot variable "+E+" = "+C),"<undef>"===C?delete this._bvars[E]:this._bvars[E]=C;else if("array"===D){if(this.say("Set array "+E+" = "+C),"<undef>"===C){delete this._arrays[E];continue}var F=C.split("<crlf>");z=[];var G;for(w=0,G=F.length;G>w;w++){var H=F[w];if(H.indexOf("|")>-1){{H.split("|")}z.push.apply(z,H.split("|"))}else z.push.apply(z,H.split(" "))}for(w=0,G=z.length;G>w;w++)z[w]=z[w].replace(/\\s/gi," ");this._arrays[E]=z}else"sub"===D?(this.say("Set substitution "+E+" = "+C),"<undef>"===C?delete this._subs[E]:this._subs[E]=C):"person"===D?(this.say("Set person substitution "+E+" = "+C),"<undef>"===C?delete this._person[E]:this._person[E]=C):this.warn("Unknown definition type '"+D+"'",a,e);continue;case">":var I=this._strip(t).split(" ");if(D=I.shift(),this.say("line: "+t+"; temp: "+I+"; type: "+D),E="",z=[],I.length>0&&(E=I.shift()),I.length>0&&(z=I),"begin"===D&&(this.say("Found the BEGIN block."),D="topic",E="__begin__"),"topic"===D){this.say("Set topic to "+E),k="",d=E;var J="";if(z.length>=2)for(w=0;w<z.length;w++){var K=z[w];"includes"===K||"inherits"===K?J=K:""!==J&&("includes"===J?(this._includes[E]||(this._includes[E]={}),this._includes[E][K]=1):(this._lineage[E]||(this._lineage[E]={}),this._lineage[E][K]=1))}}else if("object"===D){var L;z.length>0&&(L=z[0].toLowerCase()),k="",void 0===L&&(this.warn("Trying to parse unknown programming language",a,e),L="javascript"),this._handlers[L]?(h=E,i=L,j=[],g=!0):(h="",i="",j=[],g=!0)}else this.warn("Unknown label type '"+D+"'",a,e);continue;case"<":D=t,"begin"===D||"topic"===D?(this.say("End the topic label."),d="random"):"object"===D&&(this.say("End the object label."),g=!1);continue;case"+":this.say("Trigger pattern: "+t),n.length>0?this._initTT("thats",d,n,t):this._initTT("topics",d,t),k=t,l=0,m=0;continue;case"-":if(""===k){this.warn("Response found before trigger",a,e);continue}this.say("Response: "+t),n.length>0?this._thats[d][n][k].reply[l]=t:this._topics[d][k].reply[l]=t,l++;continue;case"%":continue;case"^":continue;case"@":this.say("Redirect response to: "+t),n.length>0?this._thats[d][n][k].redirect=this._strip(t):this._topics[d][k].redirect=this._strip(t);continue;case"*":this.say("Adding condition: "+t),n.length>0?this._thats[d][n][k].condition[m]=t:this._topics[d][k].condition[m]=t,m++;continue;default:this.warn("Unknown command '"+u+"'",a,e)}}}else{if(t.indexOf("*/")>-1)continue;f=!0}else this.warn("Using the # symbol for comments is deprecated",a,e)}return!0},RiveScript.prototype.checkSyntax=function(a,b){var c,d;if("!"===a){if(c=b.match(/^.+(?:\s+.+|)\s*=\s*.+?$/),!c)return"Invalid format for !Definition line: must be '! type name = value' OR '! type = value'"}else if(">"===a){if(d=b.split(/\s+/),"begin"===d[0]&&d.length>1)return"The 'begin' label takes no additional arguments.";if("topic"===d[0]){if(c=b.match(/[^a-z0-9_\-\s]/))return"Topics should be lowercased and contain only letters and numbers."}else if("object"===d[0]&&(c=b.match(/[^A-Za-z0-9\_\-\s]/)))return"Objects can only contain numbers and letters."}else if("+"===a||"%"===a||"@"===a){var e,f,g,h;if(e=f=g=h=0,this._utf8){if(b.match(/[A-Z\\.]/))return"Triggers can't contain uppercase letters, backslashes or dots in UTF-8 mode."}else if(b.match(/[^a-z0-9(|)\[\]*_#@{}<>=\s]/))return"Triggers may only contain lowercase letters, numbers, and these symbols: ( | ) [ ] * _ # @ { } < > =";for(var i=b.split(""),j=0,k=i.length;k>j;j++)switch(i[j]){case"(":e++;continue;case")":e--;continue;case"[":f++;continue;case"]":f--;continue;case"{":g++;continue;case"}":g--;continue;case"<":h++;continue;case">":h--;continue}if(0!==e)return"Unmatched parenthesis brackets.";if(0!==f)return"Unmatched square brackets.";if(0!==g)return"Unmatched curly brackets.";if(0!==h)return"Unmatched angle brackets."}else if("*"===a&&(c=b.match(/^.+?\s*(?:==|eq|!=|ne|<>|<|<=|>|>=)\s*.+?=>.+?$/),!c))return"Invalid format for !Condition: should be like '* value symbol value => response'";return""},RiveScript.prototype._initTT=function(a,b,c,d){"topics"===a?(this._topics[b]||(this._topics[b]={}),this._topics[b][c]||(this._topics[b][c]={reply:{},condition:{},redirect:void 0})):"thats"===a&&(this._thats[b]||(this._thats[b]={}),this._thats[b][c]||(this._thats[b][c]={}),this._thats[b][c][d]||(this._thats[b][c][d]={reply:{},condition:{},redirect:void 0}))},RiveScript.prototype.sortReplies=function(a){var b,c;void 0!==a?(b=this._thats,c="thats"):(b=this._topics,c="topics"),this._sorted[c]={},this.say("Sorting triggers...");for(var d in b){this.say("Analyzing topic "+d);var e=this._topic_triggers(d,b),f=this._sort_trigger_set(e);this._sorted[c]||(this._sorted[c]={}),this._sorted[c][d]=f}void 0===a&&(this.sortReplies(!0),this._sort_that_triggers(),this._sort_list("subs",Object.keys(this._subs)),this._sort_list("person",Object.keys(this._person)))},RiveScript.prototype._sort_that_triggers=function(){this.say("Sorting reverse triggers for %Previous groups..."),this._sorted.that_trig={};for(var a in this._thats){this._sorted.that_trig[a]||(this._sorted.that_trig[a]={});for(var b in this._thats[a]){this._sorted.that_trig[a][b]||(this._sorted.that_trig[a][b]=[]);var c=this._sort_trigger_set(Object.keys(this._thats[a][b]));this._sorted.that_trig[a][b]=c}}},RiveScript.prototype._sort_trigger_set=function(a){var b,c,d,e,f,g,h,i={0:[]};for(d=0,e=a.length;e>d;d++){b=a[d],c=b.match(/\{weight=(\d+)\}/i);var j=0;c&&c[1]&&(j=c[1]),i[j]||(i[j]=[]),i[j].push(b)}var k=[],l=Object.keys(i).sort(function(a,b){return b-a});for(d=0,e=l.length;e>d;d++){var m=l[d];this.say("Sorting triggers with priority "+m);var n=-1,o=-1,p={};for(p[n]=this._init_sort_track(),f=0,g=i[m].length;g>f;f++)b=i[m][f],this.say("Looking at trigger: "+b),c=b.match(/\{inherits=(\d+)\}/i),c&&c[1]?(n=parseInt(c[1]),n>o&&(o=n),this.say("Trigger belongs to a topic that inherits other topics. Level="+n),b=b.replace(/\{inherits=\d+\}/gi,"")):n=-1,p[n]||(p[n]=this._init_sort_track()),b.indexOf("_")>-1?(h=this._word_count(b),this.say("Has a _ wildcard with "+h+" words."),h>1?(p[n].alpha[h]||(p[n].alpha[h]=[]),p[n].alpha[h].push(b)):p[n].under.push(b)):b.indexOf("#")>-1?(h=this._word_count(b),this.say("Has a # wildcard with "+h+" words."),h>1?(p[n].number[h]||(p[n].number[h]=[]),p[n].number[h].push(b)):p[n].pound.push(b)):b.indexOf("*")>-1?(h=this._word_count(b),this.say("Has a * wildcard with "+h+" words."),h>1?(p[n].wild[h]||(p[n].wild[h]=[]),p[n].wild[h].push(b)):p[n].star.push(b)):b.indexOf("[")>-1?(h=this._word_count(b),this.say("Has optionals with "+h+" words."),p[n].option[h]||(p[n].option[h]=[]),p[n].option[h].push(b)):(h=this._word_count(b),this.say("Totally atomic trigger and "+h+" words."),p[n].atomic[h]||(p[n].atomic[h]=[]),p[n].atomic[h].push(b));p[o+1]=p[-1],delete p[-1];var q=Object.keys(p).sort(function(a,b){return a-b});for(f=0,g=q.length;g>f;f++){var r=q[f];this.say("ip="+r);for(var s=["atomic","option","alpha","number","wild"],t=0,u=s.length;u>t;t++)for(var v=s[t],w=Object.keys(p[r][v]).sort(function(a,b){return b-a}),x=0,y=w.length;y>x;x++){var z=w[x],A=p[r][v][z].sort(function(a,b){return b.length-a.length});k.push.apply(k,A)}var B=p[r].under.sort(function(a,b){return b.length-a.length}),C=p[r].pound.sort(function(a,b){return b.length-a.length}),D=p[r].star.sort(function(a,b){return b.length-a.length});k.push.apply(k,B),k.push.apply(k,C),k.push.apply(k,D)}}return k},RiveScript.prototype._sort_list=function(a,b){var c,d;this._sorted.lists||(this._sorted.lists={}),this._sorted.lists[a]=[];var e={};for(c=0,d=b.length;d>c;c++){var f=this._word_count(b[c],!0);e[f]||(e[f]=[]),e[f].push(b[c])}var g=[],h=Object.keys(e).sort(function(a,b){return b-a});for(c=0,d=h.length;d>c;c++){var i=h[c],j=e[i].sort(function(a,b){return b.length-a.length});g.push.apply(g,j)}this._sorted.lists[a]=g},RiveScript.prototype._init_sort_track=function(){return{atomic:{},option:{},alpha:{},number:{},wild:{},pound:[],under:[],star:[]}},RiveScript.prototype.setHandler=function(a,b){void 0===b?delete this._handlers[a]:this._handlers[a]=b},RiveScript.prototype.setSubroutine=function(a,b){this._handlers.javascript?this._handlers.javascript._objects[a]=b:this.warn("Can't setSubroutine: no JavaScript object handler is loaded!")},RiveScript.prototype.setGlobal=function(a,b){void 0===b?delete this._gvars[a]:this._gvars[a]=b},RiveScript.prototype.setVariable=function(a,b){void 0===b?delete this._bvars[a]:this._bvars[a]=b},RiveScript.prototype.setSubstitution=function(a,b){void 0===b?delete this._subs[a]:this._subs[a]=b},RiveScript.prototype.setPerson=function(a,b){void 0===b?delete this._person[a]:this._person[a]=b},RiveScript.prototype.setUservar=function(a,b,c){this._users[a]||(this._users[a]={topic:"random"}),void 0===c?delete this._users[a][b]:this._users[a][b]=c},RiveScript.prototype.setUservars=function(a,b){this._users[a]||(this._users[a]={topic:"random"});for(var c in b)b.hasOwnProperty(c)&&(void 0===b[c]?delete this._users[a][c]:this._users[a][c]=b[c])},RiveScript.prototype.getUservar=function(a,b){return this._users[a]&&"undefined"!=typeof this._users[a][b]?this._users[a][b]:"undefined"},RiveScript.prototype.getUservars=function(a){return void 0===a?this._clone(this._users):this._users[a]?this._clone(this._users[a]):void 0},RiveScript.prototype.clearUservars=function(a){void 0===a?this._users={}:delete this._users[a]},RiveScript.prototype.freezeUservars=function(a){this._users[a]?this._freeze[a]=this._clone(this._users[a]):this.warn("Can't freeze vars for user "+a+": not found!")},RiveScript.prototype.thawUservars=function(a,b){return"string"!=typeof b&&(b="thaw"),this._freeze[a]?void("thaw"===b?(this.clearUservars(a),this._users[a]=this._clone(this._freeze[a]),delete this._freeze[a]):"discard"===b?delete this._freeze[a]:"keep"===b?(this.clearUservars(a),this._users[a]=this._clone(this._freeze[a])):this.warn("Unsupported thaw action")):void this.warn("Can't thaw user vars: "+a+" not found!")},RiveScript.prototype.lastMatch=function(a){return this._users[a]?this._users[a].__lastmatch__:void 0},RiveScript.prototype.currentUser=function(){return void 0===this._current_user&&this.warn("currentUser() is intended to be called from within a JS object macro!"),this._current_user},RiveScript.prototype.reply=function(a,b,c){this.say("Asked to reply to ["+a+"] "+b),this._current_user=a,b=this._format_message(b);var d="";if(this._topics.__begin__){var e=this._getreply(a,"request","begin",0,c);e.indexOf("{ok}")>-1&&(d=this._getreply(a,b,"normal",0,c),e=e.replace(/\{ok\}/g,d)),d=e,d=this._process_tags(a,b,d,[],[],0,c)}else d=this._getreply(a,b,"normal",0,c);return this._users[a].__history__.input.pop(),this._users[a].__history__.input.unshift(b),this._users[a].__history__.reply.pop(),this._users[a].__history__.reply.unshift(d),this._current_user=void 0,d},RiveScript.prototype._format_message=function(a,b){return a=""+a,a=a.toLowerCase(),a=this._substitute(a,"subs"),this._utf8?(a=a.replace(/[\\<>]+/,""),b&&(a=a.replace(/[.?,!;:@#$%^&*()]/,""))):a=this._strip_nasties(a),a},RiveScript.prototype._getreply=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p;if(!this._sorted.topics)return this.warn("You forgot to call sortReplies()!"),"ERR: Replies Not Sorted";this._users[a]||(this._users[a]={topic:"random"});var q=this._users[a].topic,r=[],s=[],t="";if(this._topics[q]||(this.warn("User "+a+" was in an empty topic named '"+q+"'"),q=this._users[a].topic="random"),d>this._depth)return"ERR: Deep Recursion Detected";if("begin"===c&&(q="__begin__"),this._users[a].__history__||(this._users[a].__history__={input:["undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined"],reply:["undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined","undefined"]}),!this._topics[q])return"ERR: No default topic 'random' was found!";var u=null,v=null,w=!1;if(0===d){var x=[q];for((this._includes[q]||this._lineage[q])&&(x=this._get_topic_tree(q)),f=0,g=x.length;g>f;f++){var y=x[f];if(this.say("Checking topic "+y+" for any %Previous's."),this._sorted.thats[y]){this.say("There's a %Previous in this topic!");var z=this._users[a].__history__.reply[0];for(z=this._format_message(z,!0),this.say("Last reply: "+z),h=0,i=this._sorted.thats[y].length;i>h;h++){n=this._sorted.thats[y][h];var A=this._reply_regexp(a,n);if(this.say("Try to match lastReply ("+z+") to "+A),o=z.match(new RegExp("^"+A+"$"))){for(this.say("Bot side matched!"),s=[],j=1,k=o.length;k>j;j++)s.push(o[j]);for(j=0,k=this._sorted.that_trig[y][n].length;k>j;j++){var B=this._sorted.that_trig[y][n][j],C=this._reply_regexp(a,B);if(this.say("Now try to match "+b+" to "+C),o=b.match(new RegExp("^"+C+"$"))){if(this.say("Found a match!"),u=this._thats[y][n][B],v=B,w=!0,r=[],o.length>1)for(l=1,m=o.length;m>l;l++)r.push(o[l]);break}}}if(w)break}}if(w)break}}if(!w)for(this.say("Searching their topic for a match..."),f=0,g=this._sorted.topics[q].length;g>f;f++){n=this._sorted.topics[q][f];var D=this._reply_regexp(a,n);this.say('Try to match "'+b+'" against '+n+" ("+D+")");var E=this._is_atomic(n),F=!1;if(E)b===D&&(F=!0);else if(o=b.match(new RegExp("^"+D+"$")),o&&(F=!0,r=[],o.length>1))for(h=1,i=o.length;i>h;h++)r.push(o[h]);if(F){this.say("Found a match!"),u=this._topics[q][n]?this._topics[q][n]:this._find_trigger_by_inheritence(q,n,0),w=!0,v=n;break}}if(this._users[a].__lastmatch__=v,u)for(var G=0;1>G;G++){if(u.redirect){this.say("Redirecting us to '"+u.redirect+"'");var H=this._process_tags(a,b,u.redirect,r,s,d,e);this.say("Pretend user said: "+H),t=this._getreply(a,H,c,d+1,e);break}for(f=0;u.condition[f];f++){var I=u.condition[f].split(/\s*=>\s*/);if(I&&2===I.length){var J=I[0].match(/^(.+?)\s+(==|eq|!=|ne|<>|<|<=|>|>=)\s+(.+?)$/);if(J){var K=this._strip(J[1]),L=J[2],M=this._strip(J[3]),N=this._strip(I[1]);K=this._process_tags(a,b,K,r,s,d,e),M=this._process_tags(a,b,M,r,s,d,e),0===K.length&&(K="undefined"),0===M.length&&(M="undefined"),this.say("Check if "+K+" "+L+" "+M);var O=!1;if("eq"===L||"=="===L)K===M&&(O=!0);else if("ne"===L||"!="===L||"<>"===L)K!==M&&(O=!0);else try{K=parseInt(K),M=parseInt(M),"<"===L?M>K&&(O=!0):"<="===L?M>=K&&(O=!0):">"===L?K>M&&(O=!0):">="===L&&K>=M&&(O=!0)}catch(P){this.warn("Failed to evaluate numeric condition!")}if(O){t=N;break}}}}if(void 0!==t&&t.length>0)break;var Q=[];for(var R in u.reply){var S=u.reply[R],T=1;for(o=S.match(/\{weight=(\\d+?)\}/i),o&&(T=o[1],0>=T&&(this.warn("Can't have a weight <= 0!"),T=1)),h=0;T>h;h++)Q.push(S)}var U=parseInt(Math.random()*Q.length);t=Q[U];break}if(w?(void 0===t||0===t.length)&&(t="ERR: No Reply Found"):t="ERR: No Reply Matched",this.say("Reply: "+t),"begin"===c){p=0;var V;for(o=t.match(/\{topic=(.+?)\}/i);o;){if(p++,p>=50){this.warn("Infinite loop looking for topic tag!");break}V=o[1],this._users[a].topic=V,t=t.replace(new RegExp("{topic="+this.quotemeta(V)+"}","ig"),""),o=t.match(/\{topic=(.+?)\}/i)}for(o=t.match(/<set (.+?)=(.+?)>/i),p=0;o;){if(p++,p>=50){this.warn("Infinite loop looking for set tag!");break}V=o[1];var W=o[2];this._users[a][V]=W,t=t.replace(new RegExp("<set "+this.quotemeta(V)+"="+this.quotemeta(W)+">","ig"),""),o=t.match(/<set (.+?)=(.+?)>/i)}}else t=this._process_tags(a,b,t,r,s,d,e);return t},RiveScript.prototype._reply_regexp=function(a,b){var c,d,e,f,g,h,i;for(b=b.replace(/^\*$/,"<zerowidthstar>"),b=b.replace(/\*/g,"(.+?)"),b=b.replace(/#/g,"(\\d+?)"),b=b.replace(/_/g,"(\\w+?)"),b=b.replace(/\{weight=\d+\}/g,""),b=b.replace(/<zerowidthstar>/g,"(.*?)"),e=b.match(/\[(.+?)\]/),i=0;e;){if(i++,i>=50)return this.warn("Infinite loop when trying to process optionals in trigger!"),"";var j=e[1].split("|"),k=[];for(c=0,d=j.length;d>c;c++){var l="\\s*"+j[c]+"\\s*";k.push(l)}k.push("\\s*");var m=k.join("|");m=m.replace(new RegExp(this.quotemeta("(.+?)"),"g"),"(?:.+?)"),m=m.replace(new RegExp(this.quotemeta("(\\d+?)"),"g"),"(?:\\d+?)"),m=m.replace(new RegExp(this.quotemeta("([A-Za-z]+?)"),"g"),"(?:[A-Za-z]+?)"),b=b.replace(new RegExp("\\s*\\["+this.quotemeta(e[1])+"\\]\\s*"),"(?:"+m+")"),e=b.match(/\[(.+?)\]/)}for(b=b.replace(/\\w/,"[A-Za-z]"),i=0;b.indexOf("@")>-1&&(i++,!(i>=50));)e=b.match(/\@(.+?)\b/),e&&(f=e[1],h="",this._arrays[f]&&(h="(?:"+this._arrays[f].join("|")+")"),b=b.replace(new RegExp("@"+this.quotemeta(f)+"\\b"),h));for(i=0;b.indexOf("<bot")>-1&&(i++,!(i>=50));)e=b.match(/<bot (.+?)>/i),e&&(f=e[1],h="",this._bvars[f]&&(h=this._strip_nasties(this._bvars[f])),b=b.replace(new RegExp("<bot "+this.quotemeta(f)+">"),h.toLowerCase()));for(e=b.match(/<get (.+?)>/i),i=0;e;){if(i++,i>=50){this.warn("Infinite loop looking for get tag!");break}f=e[1],g="undefined","undefined"!=typeof this._users[a][f]&&(g=this._users[a][f]),b=b.replace(new RegExp("<get "+this.quotemeta(f)+">","ig"),g),e=b.match(/<get (.+?)>/i)}if(b.indexOf("<input")>-1||b.indexOf("<reply")>-1){b=b.replace(/<input>/i,"<input1>"),b=b.replace(/<reply>/i,"<reply1>");var n=["input","reply"];for(c=0;2>c;c++){for(var o=n[c],p=1;9>=p;p++)b.indexOf("<"+o+p+">")&&(b=b.replace(new RegExp("<"+o+p+">","g"),this._users[a].__history__[o][p]));b=b.replace(new RegExp("<"+o+">","g"),this._users[a].__history__[o][0])}}return b},RiveScript.prototype._process_tags=function(a,b,c,d,e,f,g){var h=[""];h.push.apply(h,d);var i=[""];i.push.apply(i,e),1===h.length&&h.push("undefined"),1===i.length&&i.push("undefined");var j,k,l,m,n,o,p,q,r,s=0;for(c=c.replace(/<person>/gi,"{person}<star>{/person}"),c=c.replace(/<@>/gi,"{@<star>}"),c=c.replace(/<formal>/gi,"{formal}<star>{/formal}"),c=c.replace(/<sentence>/gi,"{sentence}<star>{/sentence}"),c=c.replace(/<uppercase>/gi,"{uppercase}<star>{/uppercase}"),c=c.replace(/<lowercase>/gi,"{lowercase}<star>{/lowercase}"),c=c.replace(/\{weight=\d+\}/gi,""),c=c.replace(/<star>/gi,h[1]),c=c.replace(/<botstar>/gi,i[1]),j=1;j<=h.length;j++)c=c.replace(new RegExp("<star"+j+">","ig"),h[j]);for(j=1;j<=i.length;j++)c=c.replace(new RegExp("<botstar"+j+">","ig"),i[j]);for(c=c.replace(/<input>/gi,this._users[a].__history__.input[0]),c=c.replace(/<reply>/gi,this._users[a].__history__.reply[0]),j=1;9>=j;j++)c.indexOf("<input"+j+">")&&(c=c.replace(new RegExp("<input"+j+">","ig"),this._users[a].__history__.input[j])),c.indexOf("<reply"+j+">")&&(c=c.replace(new RegExp("<reply"+j+">","ig"),this._users[a].__history__.reply[j]));for(c=c.replace(/<id>/gi,a),c=c.replace(/\\s/gi," "),c=c.replace(/\\n/gi,"\n"),c=c.replace(/\\#/gi,"#"),l=c.match(/\{random\}(.+?)\{\/random\}/i),s=0;l;){if(s++,s>50){this.warn("Infinite loop looking for random tag!");break}var t=[];p=l[1],t=p.split(p.indexOf("|")>-1?"|":" "),r=t[parseInt(Math.random()*t.length)],c=c.replace(new RegExp("\\{random\\}"+this.quotemeta(p)+"\\{\\/random\\}","ig"),r),l=c.match(/\{random\}(.+?)\{\/random\}/i)}var u=["person","formal","sentence","uppercase","lowercase"];for(j=0;5>j;j++){var v=u[j];for(l=c.match(new RegExp("{"+v+"}(.+?){/"+v+"}","i")),s=0;l;){if(s++,s>=50){this.warn("Infinite loop looking for "+v+" tag!");break}var w,x=l[1];w="person"===v?this._substitute(x,"person"):this._string_format(v,x),c=c.replace(new RegExp("{"+v+"}"+this.quotemeta(x)+"{/"+v+"}","ig"),w),l=c.match(new RegExp("{"+v+"}(.+?){/"+v+"}","i"))}}for(c=c.replace(/<call>/gi,"{__call__}"),c=c.replace(/<\/call>/gi,"{/__call__}");;){if(l=c.match(/<([^<]+?)>/),!l)break;l=l[1],q=l.split(" ",2);var y=q[0].toLowerCase(),z="";q.length>1&&(z=q[1]);var A="";if("bot"===y||"env"===y)o="bot"===y?this._bvars:this._gvars,z.indexOf("=")>-1?(q=z.split("=",2),this.say("Set "+y+" variable "+q[0]+" = "+q[1]),o[q[0]]=q[1]):A=o[z]||"undefined";else if("set"===y)q=z.split("=",2),this.say("Set uservar "+q[0]+" = "+q[1]),this._users[a][q[0]]=q[1];else if("add"===y||"sub"===y||"mult"===y||"div"===y)if(q=z.split("="),m=q[0],n=q[1],"undefined"!=typeof this._users[a][m]&&(this._users[a][m]=0),n=parseInt(n),isNaN(n))A="[ERR: Math can't '"+y+"' non-numeric value '"+n+"']";else if(isNaN(parseInt(this._users[a][m])))A="[ERR: Math can't '"+y+"' non-numeric user variable '"+m+"']";else{var B=parseInt(this._users[a][m]),C=0;"add"===y?C=B+n:"sub"===y?C=B-n:"mult"===y?C=B*n:"div"===y&&(0===n?A="[ERR: Can't Divide By Zero]":C=B/n),""===A&&(this._users[a][m]=C)}else A="get"===y?this._users[a][z]:"\x00"+l+"";c=c.replace(new RegExp("<"+l+">"),A)}for(c=c.replace(/\x00/g,"<"),c=c.replace(/\x01/g,">"),l=c.match(/\{topic=(.+?)\}/i),s=0;l;){if(s++,s>=50){this.warn("Infinite loop looking for topic tag!");break}m=l[1],this._users[a].topic=m,c=c.replace(new RegExp("{topic="+this.quotemeta(m)+"}","ig"),""),l=c.match(/\{topic=(.+?)\}/i)}for(l=c.match(/\{@(.+?)\}/),s=0;l;){if(s++,s>=50){this.warn("Infinite loop looking for redirect tag!");break}o=this._strip(l[1]),this.say("Inline redirection to: "+o);var D=this._getreply(a,o,"normal",f+1,g);c=c.replace(new RegExp("\\{@"+this.quotemeta(o)+"\\}","i"),D),l=c.match(/\{@(.+?)\}/)}for(c=c.replace(/\{__call__\}/g,"<call>"),c=c.replace(/\{\/__call__\}/g,"</call>"),l=c.match(/<call>(.+?)<\/call>/i),s=0;l;){if(s++,s>=50){this.warn("Infinite loop looking for call tag!");break}p=this._strip(l[1]),q=p.split(/\s+/);var E=q[0],F=[];for(j=1,k=q.length;k>j;j++)F.push(q[j]);if(r="",this._objlangs[E]){var G=this._objlangs[E];r=this._handlers[G]?this._handlers[G].call(this,E,F,g):"[ERR: No Object Handler]"}else r="[ERR: Object Not Found]";c=c.replace(new RegExp("<call>"+this.quotemeta(l[1])+"</call>","i"),r),l=c.match(/<call>(.+?)<\/call>/i)}return c},RiveScript.prototype._substitute=function(a,b){var c;if(!this._sorted.lists||!this._sorted.lists[b])return this.warn("You forgot to call sortReplies()!"),"";var d;d="subs"===b?this._subs:this._person;for(var e=[],f=0,g=0,h=this._sorted.lists[b].length;h>g;g++){var i=this._sorted.lists[b][g];c=d[i];var j=this.quotemeta(i);e.push(c);var k="\x00"+f+"\x00";f++,a=a.replace(new RegExp("^"+j+"$","g"),k),a=a.replace(new RegExp("^"+j+"(\\W+)","g"),k+"$1"),a=a.replace(new RegExp("(\\W+)"+j+"(\\W+)","g"),"$1"+k+"$2"),a=a.replace(new RegExp("(\\W+)"+j+"$","g"),"$1"+k)}for(var l=0;a.indexOf("\x00")>-1;){if(l++,l>50){this.warn("Too many loops in substitution placeholders!");break}var m=a.match("\\x00(.+?)\\x00");if(m){var n=parseInt(m[1]);c=e[n],a=a.replace(new RegExp("\x00"+n+"\x00","g"),c)}}return a},RiveScript.prototype._is_atomic=function(a){for(var b=["*","#","_","(","[","<"],c=0,d=b.length;d>c;c++)if(a.indexOf(b[c])>-1)return!1;return!0},RiveScript.prototype._topic_triggers=function(a,b,c,d,e){var f;if(void 0===c&&(c=0),void 0===d&&(d=0),void 0===e&&(e=0),c>this._depth)return void this.warn("Deep recursion while scanning topic inheritence!");this.say("Collecting trigger list for topic "+a+" (depth="+c+"; inheritence="+d+"; inherited="+e+")");var g=[],h=[];if(b[a])for(f in b[a])h.push(f);if(this._includes[a])for(var i in this._includes[a])this.say("Topic "+a+" includes "+i),g.push.apply(g,this._topic_triggers(i,b,c+1,d+1,!0));if(this._lineage[a])for(var j in this._lineage[a])this.say("Topic "+a+" inherits "+j),g.push.apply(g,this._topic_triggers(j,b,c+1,d+1,!1));if(this._lineage[a]||e)for(var k=0,l=h.length;l>k;k++)f=h[k],this.say("Prefixing trigger with {inherits="+d+"}"+f),g.push.apply(g,["{inherits="+d+"}"+f]);else g.push.apply(g,h);return g},RiveScript.prototype._find_trigger_by_inheritence=function(a,b,c){var d;if(c>this._depth)return void this.warn("Deep recursion detected while following an inheritence trail!");if(this._lineage[a])for(var e in this._lineage[a]){if(this._topics[e][b])return this._topics[e][b];if(d=this._find_trigger_by_inheritence(e,b,c+1))return d}if(this._includes[a])for(var f in this._includes[a]){if(this._topics[f][b])return this._topics[f][b];if(d=this._find_trigger_by_inheritence(f,b,c+1))return d}return void this.warn("User matched a trigger, "+b+", but I can't find out what topic it belongs to!")},RiveScript.prototype._get_topic_tree=function(a,b){if("number"!=typeof b&&(b=0),b>this._depth)return this.warn("Deep recursion while scanning topic tree!"),[];var c=[a];if(this._includes[a])for(var d in this._includes[a])c.push.apply(c,this._get_topic_tree(d,b+1));if(this._lineage[a])for(var e in this._lineage[a])c.push.apply(c,this._get_topic_tree(e,b+1));return c},RiveScript.prototype._strip=function(a){return a=a.replace(/^[\s\t]+/i,""),a=a.replace(/[\s\t]+$/i,""),a=a.replace(/[\x0D\x0A]+/i,"")},RiveScript.prototype._word_count=function(a,b){var c=[];c=a.split(b?/\s+/:/[\s\*\#\_\|]+/);for(var d=0,e=0,f=c.length;f>e;e++)c[e].length>0&&d++;return d},RiveScript.prototype.quotemeta=function(a){for(var b="\\.+*?[^]$(){}=!<>|:",c=0,d=b.length;d>c;c++)a=a.replace(new RegExp("\\"+b.charAt(c),"g"),"\\"+b.charAt(c));return a},RiveScript.prototype._rot13=function(a){for(var b="",c=0,d=a.length;d>c;c++){var e=a.charCodeAt(c);e>=65&&77>=e?e+=13:e>=97&&109>=e?e+=13:e>=78&&90>=e?e-=13:e>=110&&122>=e&&(e-=13),b+=String.fromCharCode(e)}return b},RiveScript.prototype._string_format=function(a,b){var c;if("uppercase"===a)return b.toUpperCase();if("lowercase"===a)return b.toLowerCase();if("sentence"===a)return b+="",c=b.charAt(0).toUpperCase(),c+b.substring(1);if("formal"===a){for(var d=b.split(/\s+/),e=0;e<d.length;e++)c=d[e].charAt(0).toUpperCase(),d[e]=c+d[e].substring(1);return d.join(" ")}return b},RiveScript.prototype._strip_nasties=function(a){return a=this._utf8?a.replace(/[\\<>]+/g,""):a.replace(/[^A-Za-z0-9 ]/g,"")},RiveScript.prototype._escape_html=function(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/"/g,"&quot;")},RiveScript.prototype._clone=function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=this._clone(a[c]);return b},RiveScript.prototype._shim_keys=function(){Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError("Object.keys called on non-object");var f=[];for(var g in e)a.call(e,g)&&f.push(g);if(b)for(var h=0;d>h;h++)a.call(e,c[h])&&f.push(c[h]);
return f}}())},publish(RiveScript)}(function(a){"undefined"!=typeof window&&this===window?window.RiveScript=a:"undefined"!=typeof module?module.exports=a:RiveScript=a});